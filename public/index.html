<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå¯è‹æ²åŒ»ç–—AIåŠ©æ‰‹</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- Markdownè§£æå’Œä»£ç é«˜äº® -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css">
</head>
<body>
    <!-- ç§»åŠ¨ç«¯é®ç½© -->
    <div class="sidebar-overlay"></div>
    
    <div class="container">
        <!-- å·¦ä¾§å¯¹è¯åˆ—è¡¨ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        <circle cx="12" cy="12" r="1"/>
                    </svg>
                    <span class="logo-text">åŒå¯è‹æ²åŒ»ç–—AIåŠ©æ‰‹</span>
                </div>
            </div>
            <button id="newChatBtn" class="new-chat-btn">
                æ–°å»ºå’¨è¯¢
            </button>
            <div id="conversationList" class="conversation-list"></div>
        </div>
        
        <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <!-- ç§»åŠ¨ç«¯å¤´éƒ¨ -->
            <div class="mobile-header">
                <button id="mobileMenuBtn" class="mobile-menu-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <span class="mobile-title">åŒå¯è‹æ²åŒ»ç–—AIåŠ©æ‰‹</span>
            </div>
            
            <div id="messageList" class="message-list">
                <div class="welcome-message">
                    é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªå¯¹è¯å¼€å§‹èŠå¤©
                </div>
            </div>
            <div class="preset-messages">
                <button class="preset-btn" data-message="ä½ å¯ä»¥åšä»€ä¹ˆï¼Ÿ">ä½ å¯ä»¥åšä»€ä¹ˆï¼Ÿ</button>
                <button class="preset-btn" data-message="æˆ‘å¥½åƒæ„Ÿå†’äº†..">æˆ‘å¥½åƒæ„Ÿå†’äº†..</button>
                <button class="preset-btn" data-message="æ€æ ·åƒçš„å¥åº·ï¼Ÿ">æ€æ ·åƒçš„å¥åº·ï¼Ÿ</button>
            </div>
            <div class="input-area">
                <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled></textarea>
                <button id="sendBtn" disabled>å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        let currentConversationId = null;
        const API_BASE = '/api';
        
        // æ»šåŠ¨æ§åˆ¶å˜é‡
        let isUserScrolling = false;
        let autoScrollTimeout = null;
        
        // DOMå…ƒç´ 
        const conversationList = document.getElementById('conversationList');
        const messageList = document.getElementById('messageList');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        
        // æ™ºèƒ½æ»šåŠ¨å‡½æ•°
        function scrollToBottomIfNeeded() {
            if (!isUserScrolling) {
                messageList.scrollTop = messageList.scrollHeight;
            }
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ­£åœ¨åº•éƒ¨
        function isAtBottom() {
            const threshold = 50; // 50pxçš„å®¹å·®
            return messageList.scrollTop + messageList.clientHeight >= messageList.scrollHeight - threshold;
        }
        
        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        messageList.addEventListener('scroll', () => {
            // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
            if (autoScrollTimeout) {
                clearTimeout(autoScrollTimeout);
            }
            
            // å¦‚æœç”¨æˆ·æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œå–æ¶ˆç”¨æˆ·æ»šåŠ¨çŠ¶æ€
            if (isAtBottom()) {
                isUserScrolling = false;
            } else {
                // ç”¨æˆ·å‘ä¸Šæ»šåŠ¨äº†
                isUserScrolling = true;
                
                // 3ç§’åé‡æ–°å¯ç”¨è‡ªåŠ¨æ»šåŠ¨ï¼ˆå¦‚æœç”¨æˆ·æ²¡æœ‰ç»§ç»­æ»šåŠ¨ï¼‰
                autoScrollTimeout = setTimeout(() => {
                    if (isAtBottom()) {
                        isUserScrolling = false;
                    }
                }, 3000);
            }
        });
        
        // åŠ è½½å¯¹è¯åˆ—è¡¨
        async function loadConversations() {
            try {
                const response = await fetch(`${API_BASE}/conversations`);
                const conversations = await response.json();
                
                conversationList.innerHTML = '';
                conversations.forEach(conv => {
                    const div = document.createElement('div');
                    div.className = 'conversation-item';
                    if (conv.id === currentConversationId) {
                        div.classList.add('active');
                    }
                    div.innerHTML = `
                        <span>${conv.title}</span>
                        <button class="delete-btn" data-id="${conv.id}">Ã—</button>
                    `;
                    div.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('delete-btn')) {
                            selectConversation(conv.id);
                        }
                    });
                    conversationList.appendChild(div);
                });
                
                // åˆ é™¤æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
                            await deleteConversation(btn.dataset.id);
                        }
                    });
                });
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯å¤±è´¥:', error);
            }
        }
        
        // é€‰æ‹©å¯¹è¯
        async function selectConversation(id) {
            // æ¸…ç†ä¹‹å‰çš„æ ‡é¢˜ç›‘æ§
            if (titleUpdateMonitor) {
                clearInterval(titleUpdateMonitor);
                titleUpdateMonitor = null;
                console.log('åˆ‡æ¢å¯¹è¯ï¼Œæ¸…ç†æ ‡é¢˜ç›‘æ§å™¨');
            }
            
            currentConversationId = id;
            messageInput.disabled = false;
            sendBtn.disabled = false;
            
            // æ›´æ–°UI
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
                const deleteBtn = item.querySelector('.delete-btn');
                if (deleteBtn && deleteBtn.dataset.id == id) {
                    item.classList.add('active');
                }
            });
            
            // åŠ è½½æ¶ˆæ¯
            await loadMessages();
        }
        
        // æ›´æ–°é¢„è®¾æ¶ˆæ¯æ˜¾ç¤ºçŠ¶æ€
        function updatePresetMessagesVisibility() {
            const presetMessages = document.querySelector('.preset-messages');
            if (!presetMessages) return;
            
            const messageCount = messageList.querySelectorAll('.message').length;
            if (messageCount === 0 && currentConversationId) {
                // æœ‰å¯¹è¯ä½†æ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºé¢„è®¾æ¶ˆæ¯
                presetMessages.style.display = 'flex';
            } else if (messageCount > 0) {
                // æœ‰æ¶ˆæ¯ï¼Œéšè—é¢„è®¾æ¶ˆæ¯
                presetMessages.style.display = 'none';
            } else {
                // æ²¡æœ‰å¯¹è¯ï¼Œéšè—é¢„è®¾æ¶ˆæ¯
                presetMessages.style.display = 'none';
            }
        }
        
        // åŠ è½½æ¶ˆæ¯
        async function loadMessages() {
            if (!currentConversationId) return;
            
            try {
                const response = await fetch(`${API_BASE}/conversations/${currentConversationId}/messages`);
                const messages = await response.json();
                
                messageList.innerHTML = '';
                messages.forEach(msg => {
                    addMessageToUI(msg.role, msg.content);
                });
                
                if (messages.length === 0) {
                    messageList.innerHTML = '<div class="welcome-message">æ‚¨å¥½ï¼Œæˆ‘æ˜¯åŒ»ç–—å¥åº·AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</div>';
                }
                
                // æ›´æ–°é¢„è®¾æ¶ˆæ¯æ˜¾ç¤ºçŠ¶æ€
                updatePresetMessagesVisibility();
                
                // é‡ç½®ç”¨æˆ·æ»šåŠ¨çŠ¶æ€ï¼ˆåŠ è½½æ–°å¯¹è¯æ—¶ï¼‰
                isUserScrolling = false;
                scrollToBottomIfNeeded();
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
            }
        }
        
        // åˆ›å»ºæ–°å¯¹è¯
        async function createNewConversation(isAuto = false) {
            try {
                // æ¸…ç†ä¹‹å‰çš„æ ‡é¢˜ç›‘æ§
                if (titleUpdateMonitor) {
                    clearInterval(titleUpdateMonitor);
                    titleUpdateMonitor = null;
                    console.log('åˆ›å»ºæ–°å¯¹è¯ï¼Œæ¸…ç†æ ‡é¢˜ç›‘æ§å™¨');
                }
                
                const title = isAuto ? 'æ–°å¯¹è¯' : 'æ–°å¯¹è¯ ' + new Date().toLocaleString();
                const response = await fetch(`${API_BASE}/conversations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                const conv = await response.json();
                currentConversationId = conv.id;
                await loadConversations();
                await selectConversation(conv.id);
            } catch (error) {
                console.error('åˆ›å»ºå¯¹è¯å¤±è´¥:', error);
            }
        }
        
        // åˆ é™¤å¯¹è¯
        async function deleteConversation(id) {
            try {
                await fetch(`${API_BASE}/conversations/${id}`, { method: 'DELETE' });
                if (id == currentConversationId) {
                    currentConversationId = null;
                    messageList.innerHTML = '<div class="welcome-message">é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªå¯¹è¯å¼€å§‹èŠå¤©</div>';
                    messageInput.disabled = true;
                    sendBtn.disabled = true;
                    updatePresetMessagesVisibility();
                }
                await loadConversations();
            } catch (error) {
                console.error('åˆ é™¤å¯¹è¯å¤±è´¥:', error);
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !currentConversationId) return;
            
            // é‡ç½®æ»šåŠ¨çŠ¶æ€ï¼ˆç”¨æˆ·ä¸»åŠ¨å‘é€æ¶ˆæ¯æ—¶ï¼‰
            isUserScrolling = false;
            
            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶ç¦ç”¨
            messageInput.value = '';
            messageInput.disabled = true;
            sendBtn.disabled = true;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°UI
            addMessageToUI('user', content);
            
            // éšè—é¢„è®¾æ¶ˆæ¯ï¼ˆå› ä¸ºå¼€å§‹å¯¹è¯äº†ï¼‰
            updatePresetMessagesVisibility();
            
            // åˆ›å»ºAIå›å¤çš„å®¹å™¨
            const assistantDiv = document.createElement('div');
            assistantDiv.className = 'message assistant';
            assistantDiv.innerHTML = ''; // å¼€å§‹ä¸ºç©º
            messageList.appendChild(assistantDiv);
            scrollToBottomIfNeeded();
            
            let fullContent = ''; // å­˜å‚¨å®Œæ•´çš„markdownå†…å®¹
            
            try {
                const response = await fetch(`${API_BASE}/conversations/${currentConversationId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                
                if (!response.ok) {
                    throw new Error('å‘é€å¤±è´¥');
                }
                
                // å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let isStreamDone = false;
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                
                    // ä¿ç•™æœ€åä¸€æ®µï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰
                    buffer = lines.pop() || '';
                    
                    for (const chunk of lines) {
                        if (chunk.startsWith('data: ')) {
                            const data = chunk.slice(6).trim();
                            
                            if (data === '[DONE]') {
                                // æµå¼è¾“å‡ºç»“æŸ
                                console.log('æµå¼è¾“å‡ºå®Œæˆ');
                                isStreamDone = true;
                                
                                // ç¡®ä¿æœ€ç»ˆæ¸²æŸ“æ­£ç¡®
                                if (fullContent) {
                                    assistantDiv.innerHTML = renderMarkdown(fullContent);
                                    if (typeof Prism !== 'undefined') {
                                        Prism.highlightAllUnder(assistantDiv);
                                    }
                                }
                
                // æ›´æ–°å¯¹è¯åˆ—è¡¨
                await loadConversations();
                                
                                // å¦‚æœæ˜¯ç¬¬ä¸€è½®å¯¹è¯ï¼Œè®¾ç½®æŒç»­æ£€æŸ¥æ ‡é¢˜æ›´æ–°
                                const messageCount = messageList.querySelectorAll('.message').length;
                                if (messageCount === 2) { // ç”¨æˆ·æ¶ˆæ¯ + AIå›å¤ = ç¬¬ä¸€è½®å¯¹è¯
                                    console.log('ç¬¬ä¸€è½®å¯¹è¯å®Œæˆï¼Œå¼€å§‹ç›‘æ§æ ‡é¢˜æ›´æ–°...');
                                    startTitleUpdateMonitoring();
                                }
                                break;
                            }
                            
                            if (data && data !== '') {
                                try {
                                    const parsed = JSON.parse(data);
                                    if (parsed.content) {
                                        // è¿½åŠ æ–°å†…å®¹åˆ°å®Œæ•´å†…å®¹
                                        fullContent += parsed.content;
                                        
                                        // å®æ—¶æ¸²æŸ“Markdown
                                        assistantDiv.innerHTML = renderMarkdown(fullContent);
                                        
                                        // ä»£ç é«˜äº®
                                        if (typeof Prism !== 'undefined') {
                                            Prism.highlightAllUnder(assistantDiv);
                                        }
                                        
                                        scrollToBottomIfNeeded();
                                    } else if (parsed.error) {
                                        throw new Error(parsed.error);
                                    }
                                } catch (parseError) {
                                    console.warn('è§£ææµå¼æ•°æ®å¤±è´¥:', data, parseError);
                                }
                            }
                        }
                    }
                    
                    if (isStreamDone) break;
                }
            } catch (error) {
                assistantDiv.textContent = 'å‘é€å¤±è´¥: ' + error.message;
                assistantDiv.classList.add('error');
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            } finally {
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
            }
        }
        
        // Markdownæ¸²æŸ“å‡½æ•°
        function renderMarkdown(content) {
            // æ›´å½»åº•åœ°æ¸…ç†å¤šä½™çš„æ¢è¡Œç¬¦å’Œç©ºç™½
            let cleanedContent = content
                .replace(/\r\n/g, '\n')      // ç»Ÿä¸€æ¢è¡Œç¬¦
                .replace(/\r/g, '\n')        // ç»Ÿä¸€æ¢è¡Œç¬¦
                .replace(/\n{3,}/g, '\n\n')  // å°†3ä¸ªæˆ–æ›´å¤šè¿ç»­æ¢è¡Œç¬¦æ›¿æ¢ä¸º2ä¸ª
                .replace(/^\n+/, '')         // ç§»é™¤å¼€å¤´çš„æ¢è¡Œç¬¦
                .replace(/\n+$/, '')         // ç§»é™¤ç»“å°¾çš„æ¢è¡Œç¬¦
                .replace(/\n\s*\n/g, '\n\n') // æ¸…ç†åªåŒ…å«ç©ºç™½å­—ç¬¦çš„è¡Œ
                .trim();                     // ç§»é™¤é¦–å°¾ç©ºç™½
            
            // é…ç½®markedé€‰é¡¹
            marked.setOptions({
                breaks: false,  // ä¸å°†å•ä¸ªæ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
                gfm: true,
                sanitize: false,
                highlight: function(code, lang) {
                    if (lang && Prism.languages[lang]) {
                        return Prism.highlight(code, Prism.languages[lang], lang);
                    }
                    return code;
                }
            });
            
            // æ¸²æŸ“Markdown
            let html = marked.parse(cleanedContent);
            
            // åå¤„ç†ï¼šæ¸…ç†æ¸²æŸ“åçš„HTMLä¸­çš„å¤šä½™ç©ºç™½
            html = html
                .replace(/<p>\s*<\/p>/g, '')           // ç§»é™¤ç©ºçš„æ®µè½æ ‡ç­¾
                .replace(/(<\/p>)\s*(<p>)/g, '$1$2')   // ç§»é™¤æ®µè½ä¹‹é—´çš„å¤šä½™ç©ºç™½
                .replace(/\n\s*\n/g, '\n')             // ç§»é™¤HTMLä¸­çš„å¤šä½™æ¢è¡Œ
                .trim();
            
            return html;
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°UI
        function addMessageToUI(role, content) {
            // å¦‚æœæ˜¯ç”¨æˆ·çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ¸…é™¤æ¬¢è¿æ¶ˆæ¯
            if (role === 'user') {
                const welcomeMessage = messageList.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
            }
            
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            if (role === 'assistant') {
                // AIæ¶ˆæ¯ä½¿ç”¨Markdownæ¸²æŸ“
                div.innerHTML = renderMarkdown(content);
                // ä»£ç é«˜äº®
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAllUnder(div);
                }
            } else {
                // ç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
            div.textContent = content;
            }
            
            messageList.appendChild(div);
            scrollToBottomIfNeeded();
        }
        
        // æ ‡é¢˜æ›´æ–°ç›‘æ§å™¨
        let titleUpdateMonitor = null;
        
        // å¼€å§‹æ ‡é¢˜æ›´æ–°ç›‘æ§
        function startTitleUpdateMonitoring() {
            if (titleUpdateMonitor) {
                clearInterval(titleUpdateMonitor);
            }
            
            let checkCount = 0;
            let lastCheckTime = Date.now();
            const startTime = Date.now();
            
            titleUpdateMonitor = setInterval(async () => {
                checkCount++;
                const currentTime = Date.now();
                const elapsedTime = currentTime - startTime;
                
                console.log(`æ ‡é¢˜æ£€æŸ¥ #${checkCount} (å·²ç­‰å¾… ${Math.round(elapsedTime/1000)}s)`);
                
                const titleUpdated = await checkAndUpdateTitle();
                
                if (titleUpdated) {
                    console.log('âœ… æ ‡é¢˜æ›´æ–°æˆåŠŸï¼Œåœæ­¢ç›‘æ§');
                    clearInterval(titleUpdateMonitor);
                    titleUpdateMonitor = null;
                    return;
                }
                
                // åŠ¨æ€è°ƒæ•´æ£€æŸ¥é—´éš”ï¼šå‰30ç§’æ¯1ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œä¹‹åæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
                let nextInterval;
                if (elapsedTime < 30000) { // å‰30ç§’
                    nextInterval = 1000; // æ¯1ç§’æ£€æŸ¥
                } else if (elapsedTime < 120000) { // 30ç§’åˆ°2åˆ†é’Ÿ
                    nextInterval = 5000; // æ¯5ç§’æ£€æŸ¥
                } else { // 2åˆ†é’Ÿå
                    nextInterval = 10000; // æ¯10ç§’æ£€æŸ¥
                }
                
                // é‡æ–°è®¾ç½®å®šæ—¶å™¨é—´éš”
                if (currentTime - lastCheckTime !== nextInterval) {
                    clearInterval(titleUpdateMonitor);
                    titleUpdateMonitor = setTimeout(() => {
                        startTitleUpdateMonitoring(); // é‡æ–°å¼€å§‹ç›‘æ§
                    }, nextInterval);
                    lastCheckTime = currentTime;
                }
                
                // æœ€å¤šç›‘æ§10åˆ†é’Ÿï¼Œé¿å…æ— é™ç›‘æ§
                if (elapsedTime > 600000) { // 10åˆ†é’Ÿ
                    console.log('âš ï¸ æ ‡é¢˜ç›‘æ§è¶…æ—¶ï¼Œåœæ­¢ç›‘æ§');
                    clearInterval(titleUpdateMonitor);
                    titleUpdateMonitor = null;
                }
            }, 1000); // åˆå§‹é—´éš”1ç§’
        }
        
        // æ£€æŸ¥å¹¶æ›´æ–°å¯¹è¯æ ‡é¢˜
        async function checkAndUpdateTitle() {
            if (!currentConversationId) return false;
            
            try {
                const response = await fetch(`${API_BASE}/conversations/${currentConversationId}`);
                const conversation = await response.json();
                
                // æ£€æŸ¥å½“å‰æ˜¾ç¤ºçš„æ ‡é¢˜æ˜¯å¦éœ€è¦æ›´æ–°
                const activeItem = document.querySelector('.conversation-item.active span');
                if (activeItem && activeItem.textContent !== conversation.title && conversation.title !== 'æ–°å¯¹è¯') {
                    console.log('ğŸ‰ æ£€æµ‹åˆ°æ ‡é¢˜æ›´æ–°:', activeItem.textContent, '->', conversation.title);
                    
                    // ä¿å­˜å½“å‰é€‰ä¸­çš„å¯¹è¯ID
                    const savedConversationId = currentConversationId;
                    
                    // é‡æ–°åŠ è½½å¯¹è¯åˆ—è¡¨
                    await loadConversations();
                    
                    // é‡æ–°é€‰ä¸­å½“å‰å¯¹è¯ä»¥ä¿æŒçŠ¶æ€
                    const updatedActiveItem = document.querySelector(`.conversation-item .delete-btn[data-id="${savedConversationId}"]`)?.closest('.conversation-item');
                    if (updatedActiveItem) {
                        document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
                        updatedActiveItem.classList.add('active');
                    }
                    
                    return true; // æ ‡é¢˜å·²æ›´æ–°
                }
                return false; // æ ‡é¢˜æœªæ›´æ–°
            } catch (error) {
                console.error('æ£€æŸ¥æ ‡é¢˜æ›´æ–°å¤±è´¥:', error);
                return false;
            }
        }
        
        // ç§»åŠ¨ç«¯èœå•æ§åˆ¶
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.querySelector('.sidebar');
        const sidebarOverlay = document.querySelector('.sidebar-overlay');
        
        function toggleMobileMenu() {
            sidebar.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
        }
        
        function closeMobileMenu() {
            sidebar.classList.remove('open');
            document.body.classList.remove('sidebar-open');
        }
        
        // é¢„è®¾æ¶ˆæ¯ç‚¹å‡»å¤„ç†
        function handlePresetMessage(message) {
            if (!currentConversationId) {
                // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯ï¼Œå…ˆåˆ›å»ºä¸€ä¸ª
                createNewConversation(true).then(() => {
                    messageInput.value = message;
                    sendMessage();
                });
            } else {
                messageInput.value = message;
                sendMessage();
            }
        }
        
        // äº‹ä»¶ç›‘å¬
        newChatBtn.addEventListener('click', createNewConversation);
        sendBtn.addEventListener('click', sendMessage);
        mobileMenuBtn.addEventListener('click', toggleMobileMenu);
        
        // é¢„è®¾æ¶ˆæ¯æŒ‰é’®äº‹ä»¶
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('preset-btn')) {
                const message = e.target.dataset.message;
                handlePresetMessage(message);
            }
        });
        
        // ç‚¹å‡»å¯¹è¯é¡¹åå…³é—­ç§»åŠ¨ç«¯èœå•
        const originalSelectConversation = selectConversation;
        selectConversation = async function(id) {
            await originalSelectConversation.call(this, id);
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
        };
        
        // ç‚¹å‡»é®ç½©å…³é—­èœå•
        sidebarOverlay.addEventListener('click', closeMobileMenu);
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeMobileMenu();
            }
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†ç›‘æ§å™¨
        window.addEventListener('beforeunload', () => {
            if (titleUpdateMonitor) {
                clearInterval(titleUpdateMonitor);
                titleUpdateMonitor = null;
            }
        });
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // åˆå§‹åŒ–
        async function initialize() {
            await loadConversations();
            
            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„å¯¹è¯ï¼Œå°è¯•è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæˆ–åˆ›å»ºæ–°å¯¹è¯
            if (!currentConversationId) {
                const conversationItems = document.querySelectorAll('.conversation-item');
                if (conversationItems.length > 0) {
                    // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå¯¹è¯
                    const firstConvId = conversationItems[0].querySelector('.delete-btn').dataset.id;
                    await selectConversation(firstConvId);
                } else {
                    // å¦‚æœæ²¡æœ‰å¯¹è¯ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤å¯¹è¯
                    await createNewConversation(true);
                }
            }
        }
        
        initialize();
    </script>
</body>
</html>